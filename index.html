<!doctype html>
<html>
  <head>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css"
    />
    <link rel="stylesheet" type="text/css" href="./spinner.css" />
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
  </head>
  <body>
    <div id="loading" class="loading">Loading&#8230;</div>
    <table id="audits" style="width: 100%">
      <thead></thead>
      <tbody></tbody>
    </table>

    <script>
      var loadingDiv = document.getElementById("loading");
      function showSpinner() {
        loadingDiv.style.visibility = "visible";
      }
      function hideSpinner() {
        loadingDiv.style.visibility = "hidden";
      }
      showSpinner();
      const p2 = fetch(
        "https://api.github.com/repos/mamico/pa-website-validator-action/contents/?ref=gh-pages",
      )
        .then((res) => res.json())
        .then((files) => {
          // Promise(
          const p = files
            .filter((file) => file.path.match(/^\d{4}-\d{2}-\d{2}/))
            .sort((a, b) => b.path.localeCompare(a.path))
            .map((file) => {
              return fetch(
                `./${file.path}/report.json`,
              )
                .then((res) => {
                  // debugger;
                  return res.json();
                })
                .then((audit) => {
                  return {
                    report: {
                      date: audit.fetchTime,
                      url: `./${file.path}/report.html`,
                    },
                    site: audit.finalUrl,
                    performance: Math.floor(
                      audit.categories.performance?.score * 100.0,
                    ),
                    modelComplianceInformation: Math.floor(
                      audit.categories.modelComplianceInformation?.score *
                        100.0,
                    ),
                    reccomandationsAndAdditionalTests: Math.floor(
                      audit.categories.reccomandationsAndAdditionalTests
                        ?.score * 100.0,
                    ),
                    additionalTests: Math.floor(
                      audit.categories.additionalTests?.score * 100.0,
                    ),
                    // pwa: audit.categories.pwa.score,
                    // keys: Object.keys(audit.categories)
                  };
                });
            });
          Promise.all(p).then((data) => {
            console.log(data);
            const columns = Object.keys(data[0])
              .map((key) => ({ 
                name: key, 
                data: key, 
                title: key,
                render: function (data, type) {
                  if (type === "display") {
                    if (key === "report") {
                      return `<a href="${data.url}">${data.date}</a>`;
                    }
                    return data;
                  }
                  return data;
                }, 
              }));

            new DataTable("#audits", {
              columns: columns,
              scrollX: true,
              data: data,
              initComplete: function () {
                this.api()
                  .columns()
                  .every(function () {
                    let column = this;
                    if (["site"].includes(column.header().textContent)) {
                      // Create select element
                      let select = document.createElement("select");
                      select.add(new Option(""));
                      column.header().append(select);

                      // Apply listener for user change in value
                      select.addEventListener("change", function () {
                        column.search(select.value, { exact: true }).draw();
                      });

                      // Add list of options
                      column
                        .data()
                        .unique()
                        .sort()
                        .each(function (d, j) {
                          select.add(new Option(d));
                        });
                    }
                  });
                this.api().draw();
                hideSpinner();
              },
            });
          });
        });
    </script>
  </body>
</html>
