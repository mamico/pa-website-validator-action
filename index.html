<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css"
    /> -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css"
    />
    <!-- <link rel="stylesheet" type="text/css" href="./spinner.css" /> -->
    <link href="./pencil-preloader/dist/style.css" rel="stylesheet" />
    <style>
      .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 50%;
        right: 0;
        opacity: 0.8;
      }
    </style>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
  </head>
  <body>
    <!-- <div id="loading" class="loading">Loading&#8230;</div> -->
    <div id="loading" class="loading">
      <!-- https://codepen.io/jkantner/pen/xxJmMVa -->
      <!-- <img class="pencil" src="./pencil-preloader/pencil.svg"> -->
      <svg
        class="pencil"
        viewBox="0 0 200 200"
        width="200px"
        height="200px"
        xmlns="http://www.w3.org/2000/svg"
      >
        <defs>
          <clipPath id="pencil-eraser">
            <rect rx="5" ry="5" width="30" height="30"></rect>
          </clipPath>
        </defs>
        <circle
          class="pencil__stroke"
          r="70"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-dasharray="439.82 439.82"
          stroke-dashoffset="439.82"
          stroke-linecap="round"
          transform="rotate(-113,100,100)"
        />
        <g class="pencil__rotate" transform="translate(100,100)">
          <g fill="none">
            <circle
              class="pencil__body1"
              r="64"
              stroke="hsl(223,90%,50%)"
              stroke-width="30"
              stroke-dasharray="402.12 402.12"
              stroke-dashoffset="402"
              transform="rotate(-90)"
            />
            <circle
              class="pencil__body2"
              r="74"
              stroke="hsl(223,90%,60%)"
              stroke-width="10"
              stroke-dasharray="464.96 464.96"
              stroke-dashoffset="465"
              transform="rotate(-90)"
            />
            <circle
              class="pencil__body3"
              r="54"
              stroke="hsl(223,90%,40%)"
              stroke-width="10"
              stroke-dasharray="339.29 339.29"
              stroke-dashoffset="339"
              transform="rotate(-90)"
            />
          </g>
          <g class="pencil__eraser" transform="rotate(-90) translate(49,0)">
            <g class="pencil__eraser-skew">
              <rect
                fill="hsl(223,90%,70%)"
                rx="5"
                ry="5"
                width="30"
                height="30"
              />
              <rect
                fill="hsl(223,90%,60%)"
                width="5"
                height="30"
                clip-path="url(#pencil-eraser)"
              />
              <rect fill="hsl(223,10%,90%)" width="30" height="20" />
              <rect fill="hsl(223,10%,70%)" width="15" height="20" />
              <rect fill="hsl(223,10%,80%)" width="5" height="20" />
              <rect fill="hsla(223,10%,10%,0.2)" y="6" width="30" height="2" />
              <rect fill="hsla(223,10%,10%,0.2)" y="13" width="30" height="2" />
            </g>
          </g>
          <g class="pencil__point" transform="rotate(-90) translate(49,-30)">
            <polygon fill="hsl(33,90%,70%)" points="15 0,30 30,0 30" />
            <polygon fill="hsl(33,90%,50%)" points="15 0,6 30,0 30" />
            <polygon fill="hsl(223,10%,10%)" points="15 0,20 10,10 10" />
          </g>
        </g>
      </svg>
    </div>
    <header class="container">
      <h1>PA Website validator</h1>
      <p>
        This page shows the results of the audits of the PA websites.
        <a href="htpps://github.com/mamico/pa-website-validator-action"
          >Source code</a
        >
      </p>
    </header>
    <article class="container-fluid">
      <table id="audits" class="table table-striped" style="width: 100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </article>
    <script>
      var loadingDiv = document.getElementById("loading");
      function showSpinner() {
        loadingDiv.style.visibility = "visible";
      }
      function hideSpinner() {
        loadingDiv.style.visibility = "hidden";
      }
      // showSpinner();
      const p2 = fetch(
        "https://api.github.com/repos/mamico/pa-website-validator-action/contents/?ref=gh-pages",
      )
        .then((res) => res.json())
        .then((files) => {
          // Promise(
          const p = files
            .filter((file) => file.path.match(/^\d{4}-\d{2}-\d{2}/))
            // .sort((a, b) => b.path.localeCompare(a.path))
            .map((file) => {
              return fetch(
                // `https://mamico.github.io/pa-website-validator-action/${
                //   file.path
                // }/report.json`,
                `./${file.path}/report.json`,
              )
                .then((res) => {
                  // debugger;
                  return res.json();
                })
                .then((audit) => {
                  return {
                    report: {
                      date: audit.fetchTime,
                      url: `./${file.path}/report.html`,
                    },
                    site: audit.finalUrl,
                    performance: Math.floor(
                      audit.categories.performance?.score * 100.0,
                    ),
                    modelComplianceInformation: Math.floor(
                      audit.categories.modelComplianceInformation?.score *
                        100.0,
                    ),
                    reccomandationsAndAdditionalTests: Math.floor(
                      audit.categories.reccomandationsAndAdditionalTests
                        ?.score * 100.0,
                    ),
                    additionalTests: Math.floor(
                      audit.categories.additionalTests?.score * 100.0,
                    ),
                    // pwa: audit.categories.pwa.score,
                    // keys: Object.keys(audit.categories)
                  };
                });
            });
          Promise.all(p).then((data) => {
            // console.log(data);
            const columns = Object.keys(data[0]).map((key) => ({
              name: key,
              data: key,
              title: key,
              render: function (data, type) {
                if (type === "display") {
                  if (key === "report") {
                    return `<a href="${data.url}">${data.date}</a>`;
                  }
                  return data;
                }
                return data;
              },
              orderable: !["site"].includes(key),
            }));

            new DataTable("#audits", {
              columns: columns,
              scrollX: true,
              order: [[0, "desc"]],
              data: data,
              initComplete: function () {
                this.api()
                  .columns()
                  .every(function () {
                    let column = this;
                    if (["site"].includes(column.header().textContent)) {
                      // Create select element
                      let select = document.createElement("select");
                      select.add(new Option(""));
                      column.header().append(select);
                      // Apply listener for user change in value
                      select.addEventListener("change", function () {
                        column.search(select.value, { exact: true }).draw();
                        //.sort([[0, 'desc']]);
                      });
                      // Add list of options
                      column
                        .data()
                        .unique()
                        .sort()
                        .each(function (d, j) {
                          select.add(new Option(d));
                        });
                    }
                  });
                this.api().draw();
                hideSpinner();
              },
            });
          });
        });
    </script>
  </body>
</html>
